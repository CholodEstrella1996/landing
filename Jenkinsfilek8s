pipeline {
  agent any
  stages {
    stage('Deploy through SSH  ') {
      steps {
        script {
          def remote = [name: 'ubuntu', host: '3.220.130.207', user: 'ubuntu', allowAnyHosts: true]
          withCredentials([sshUserPrivateKey(credentialsId: 'ec2-dev-cloudlabs', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'ubuntu')]) {
            remote.user = ubuntu
            remote.identityFile = identity
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; aws ecr get-login-password --regio us-east-1 | docker login --username AWS --password-stdin 548364670481.dkr.ecr.us-east-1.amazonaws.com/repoprod'
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; aws ecr batch-delete-image --repository-name repoprod --image-ids imageTag=landing-client'
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; git checkout master ; git pull'
            /*sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; docker build --tag landing-client .'*/
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client/docker ; docker-compose build'
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; docker tag docker_cloudlabs-landing-client:latest 548364670481.dkr.ecr.us-east-1.amazonaws.com/repoprod:landing-client'
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; docker push 548364670481.dkr.ecr.us-east-1.amazonaws.com/repoprod:landing-client'
            sshCommand remote: remote, command: 'cd /home/ubuntu/prod-cloudlabs/cloudlabs-landing-client ; kubectl rollout restart deployment/deployment-landing-client -n prod-namespace'
            sshCommand remote: remote, command: 'docker system prune -af'
          }
        }
      }
    }
  }
  post {
      success {
         mail to:"nsaenz@folcode.com", subject:"SUCCESS: ${currentBuild.fullDisplayName}", body: "Well done is better than well said."
      }
      failure {
         mail to:"nsaenz@folcode.com", subject:"FAILURE: ${currentBuild.fullDisplayName}", body: "Houston, we have a problem here."
      }   
    }
}